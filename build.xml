<?xml version="1.0"?>

<project default="compile">
    <target name="settings">
        <property file="ant.settings"/>
        <fail
            message="Please copy ant.settings.template to ant.settings, and set the variables in it."
            unless="jasmin.jar"
        />
    </target>

    <target name="compile" depends="settings,sablecc,copypeephole,settings">
        <javac
            destdir="classes"
            classpath="classes:${polyglot.jar}:${jasmin.jar}"
            debug="true"
        >
            <src path="src"/>
            <src path="generated/sablecc"/>
            <src path="generated/options"/>
            <src path="generated/jedd"/>
        </javac>
    </target>

    <target name="options" depends="settings">
        <xslt
            style="src/soot/options/make-soot-options.xsl"
            in="src/soot/options/soot_options.xml"
            out="generated/options/soot/options/Options.java"
        />
    </target>

    <target name="copypeephole" depends="sablecc,settings">
        <copy file="src/soot/baf/toolkits/base/peephole.dat" tofile="classes/soot/baf/toolkits/base/peephole.dat"/>
        <copy file="generated/sablecc/soot/jimple/parser/parser/parser.dat" tofile="classes/soot/jimple/parser/parser/parser.dat"/>
        <copy file="generated/sablecc/soot/jimple/parser/lexer/lexer.dat" tofile="classes/soot/jimple/parser/lexer/lexer.dat"/>
    </target>

    <target name="determine-sablecc-uptodate">
        <uptodate property="sablecc.uptodate" srcfile="src/jimple.scc" targetfile="generated/sablecc/soot/jimple/parser/parser/Parser.java"/>
    </target>

    <target name="sablecc" depends="determine-sablecc-uptodate,settings" unless="sablecc.uptodate">
        <apply executable="sablecc">
            <arg value="-d generated/sablecc"/>
            <fileset dir="src" includes="jimple.scc"/>
        </apply>
    </target>

    <target name="javadoc">
        <javadoc
            sourcepath="src"
            destdir="doc"
            maxmemory="200m"
            windowtitle="Soot API"
        >
            <fileset dir="src" includes="**/*.java"/>
        </javadoc>
    </target>

    <target name="clean">
    <delete quiet="true">
        <fileset dir="classes" includes="**/*.class" />
        <fileset dir="testclasses" includes="**/*.class" />
    </delete>
    </target>

    <target name="veryclean" depends="clean,settings">
    <delete quiet="true">
        <fileset dir="generated/jedd" includes="**/*" />
        <fileset dir="generated/options" includes="**/*" />
        <fileset dir="generated/sablecc" includes="**/*" />
    </delete>
    </target>

    <target name="badfields" depends="compile,settings">
        <java
            classname="soot.tools.BadFields"
            maxmemory="200m"
            fork="true"
            classpath="classes:${polyglot.jar}:${jasmin.jar}"
        >
            <arg value="-w"/>
            <arg value="-f"/>
            <arg value="none"/>
            <arg value="-process-dir"/>
            <arg value="classes"/>
            <arg value="soot.Main"/>
        </java>
    </target>

    <target name="buildtests" depends="compile,settings">
        <mkdir dir="testclasses"/>
        <javac
            srcdir="tests"
            destdir="testclasses"
            classpath="classes:${polyglot.jar}:${jasmin.jar}"
            debug="true"
            />
    </target>

    <target name="runtests" depends="buildtests,settings">
        <junit printsummary="yes">
            <classpath>
                <pathelement location="testclasses"/>
                <pathelement location="classes"/>
                <pathelement location="${polyglot.jar}"/>
                <pathelement location="${jasmin.jar}"/>
            </classpath>

            <formatter type="plain"/>
            <batchtest>
                <fileset dir="testclasses" includes="**/*.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="release" depends="barebones,settings">
        <property file="ant.settings"/>
    </target>

    <target name="barebones" depends="clean,options,sablecc,settings">
        <property file="ant.settings"/>
        <tar destfile="${release.loc}/soot-${soot.version}-barebones.tar.gz" compression="gzip" longfile="gnu">
            <tarfileset dir="."/>
        </tar>
        <jar destfile="${release.loc}/soot-${soot.version}-barebones.jar">
            <fileset dir="."/>
        </jar>
    </target>

    <target name="eclipse-plugin" depends="compile,settings">
        <xslt
            style="src/soot/options/phase_options_dialog.xsl"
            in="src/soot/options/soot_options.xml"
            out="eclipse/ca.mcgill.sable.soot/src/ca/mcgill/sable/soot/testing/PhaseOptionsDialog.java"
        />
        <javac
            destdir="eclipse/ca.mcgill.sable.soot/classes"
            debug="true"
        >
            <src path="eclipse/ca.mcgill.sable.soot/src"/>
            <classpath>
                <pathelement location="classes"/>
                <fileset dir="${eclipse.loc}/plugins/" includes="**/*.jar"/>
            </classpath>
        </javac>
        <jar destfile="eclipse/ca.mcgill.sable.soot/soot-plugin.jar">
            <fileset dir="eclipse/ca.mcgill.sable.soot/classes"/>
        </jar>
    </target>

</project>
